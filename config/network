
config interface 'loopback'
	option device 'lo'
	option proto 'static'
	option ipaddr '127.0.0.1'
	option netmask '255.0.0.0'

config globals 'globals'
	option ula_prefix '{{ ula_prefix }}'

config device
{% if vlans is defined %}
	option name 'eth0.{{ vlans | community.general.json_query('[?wan].vid') | first }}'
{% else %}
	option name 'eth0.2'
{% endif %}
	option macaddr '{{ mac }}'

config switch
	option name 'switch0'
	option reset '1'
	option enable_vlan '1'

config device
	option name 'br-lan'
	option type 'bridge'
	list ports 'eth0.1'

{% if inventory_hostname in groups['routers'] %}
config interface 'lan'
	option device 'br-lan'
	option proto 'static'
	option netmask '{{ network | ansible.utils.ipaddr('netmask') }}'
	option ip6assign '60'
	option ipaddr '{{ network | ansible.utils.ipaddr(id) | ansible.utils.ipv4('address')}}'
	option ip6ifaceid '::{{ id }}'

config interface 'wan'
{% if vlans is defined %}
	option device 'eth0.{{ vlans | community.general.json_query('[?wan].vid') | first }}'
{% else %}
	option device 'eth0.2'
{% endif %}
	option proto 'dhcp'

config interface 'wan6'
{% if vlans is defined %}
	option device 'eth0.{{ vlans | community.general.json_query('[?wan].vid') | first }}'
{% else %}
	option device 'eth0.2'
{% endif %}
	option proto 'dhcpv6'
	option reqaddress 'try'
	option reqprefix 'auto'

config switch_vlan
	option device 'switch0'
	option vlan '1'
	option ports '0t 2 3 4 5'
	option vid '1'

{% if vlans is defined %}
{% for vlan in vlans %}
config switch_vlan
	option device 'switch0'
	option vlan '{{ loop.index+1 }}'
	option ports '{{ vlan.ports }}'
	option vid '{{ vlan.vid }}'
{% if vlan.name is defined %}
	option description '{{ vlan.name }}'
{% endif %}

{% endfor %}
{% else %}
config switch_vlan
	option device 'switch0'
	option vlan '2'
	option ports '0t 1'
	option vid '2'
{% endif %}

{% if ipv6_6to4 is defined %}
config interface 'wan6to4'
	option proto '6to4'
{% if not ipv6_6to4.enabled %}
	option auto '0'
{% endif %}
{% endif %}

{% if henet is defined %}
config interface 'henet'
	option proto '6in4'
	option username '{{ henet.username }}'
	option peeraddr '{{ henet.peeraddr }}'
	list ip6prefix '{{ henet.ip6prefix }}'
	option ip6addr '{{ henet.ip6addr }}'
	option tunnelid '{{ henet.tunnelid }}'
	option password '{{ henet.password }}'
{% if not henet.enabled %}
	option auto '0'
{% endif %}
{% endif %}

{% else %}
config interface 'lan'
	option device 'br-lan'
	option proto 'dhcp'

config switch_vlan
	option device 'switch0'
	option vlan '1'
	option ports '0t 1 2 3 4 5'
	option vid '1'

config interface 'lan6'
	option proto 'dhcpv6'
	option reqaddress 'try'
	option reqprefix 'no'
	option device '@lan'
	option type 'bridge'

{% endif %}
